<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>ordepdev - Immutability and defensive copying</title>
    <meta name="description" content="ordepdev - random programming stuff" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />

    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />

</head>
<body class="home-template">
    <div class="container">
      
      <header>
  <a href="/" class="site">ordep<span class="b">dev</span></a>

  <ul>
    <li>
      <a href="/about.html">about</a>
    </li>
  </ul>
</header>


      <div class="content">
    <article>
        <header class="post-header">
            <div class="post-title">
                <h1>Immutability and defensive copying</h1>
                <section class="post-meta">                
                    <time class="post-date" datetime="May 12, 2016">May 12, 2016</time>
                    
                </section>
            </div>
        </header>

        <footer class="post-footer"></footer>

        <section class="post-content">
            <p>immutable data type; has the property that the value of an object never changes once constructed.</p>

<p>In Java, we can enforce immutability with the <em>final</em> modifier. When declaring a variable as final, we are promising to assign it a value only once.</p>

<p>What’s the point of immutable types?</p>

<ul>
  <li>the value does not change.</li>
  <li>prevents accidental changes.</li>
  <li>makes programs easier to debug.</li>
</ul>

<p>Generally, immutable types are easier to use and harder to misuse than mutable types because the scope of code that can change their values is far smaller. It is easier to debug code that uses immutable types because it is easier to guarantee that variables in client code that uses them remain in a consistent state. When using mutable types, we are always concerned about where and when their values change.</p>

<p>There are a few <em>manageable</em> downsides of immutability:</p>

<ul>
  <li>a new object must be created for every value.</li>
  <li><em>final</em> doesn’t guarantees immutability on reference types.</li>
</ul>

<p>If an instance variable of a reference type has the <em>final</em> modifier, the reference will never change but the value of the object itself <em>can</em> change.</p>

<p>We’ll take this class as an example:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">firstName</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">lastName</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">children</span><span class="o">;</span>

  <span class="kd">public</span> <span class="n">Person</span><span class="o">(</span><span class="n">String</span> <span class="n">firstName</span><span class="o">,</span> <span class="n">String</span> <span class="n">lastName</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">children</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">firstName</span> <span class="o">=</span> <span class="n">firstName</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">lastName</span> <span class="o">=</span> <span class="n">lastName</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">children</span> <span class="o">=</span> <span class="n">children</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">Date</span> <span class="n">getChildren</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">children</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>A client program could create a Person, providing an empty list of children and then populate it after construction.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">children</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

<span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="s">"John"</span><span class="o">,</span> <span class="s">"Doe"</span><span class="o">,</span> <span class="n">children</span><span class="o">);</span>
<span class="n">Person</span> <span class="n">child1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="s">"Jack"</span><span class="o">,</span> <span class="s">"Doe"</span><span class="o">,</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">());</span>
<span class="n">Person</span> <span class="n">child2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="s">"Jane"</span><span class="o">,</span> <span class="s">"Doe"</span><span class="o">,</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">());</span>

<span class="n">children</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">child1</span><span class="o">);</span>
<span class="n">children</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">child2</span><span class="o">);</span>

<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="na">getChildren</span><span class="o">().</span><span class="na">size</span><span class="o">())</span> <span class="c1">// =&gt; 2.</span>
</code></pre>
</div>

<p>The instance <em>children</em> is private and also final, but <code class="highlighter-rouge">List&lt;Person&gt;</code> is mutable because the client holds a reference to the data.</p>

<p>How can we fix this? With <em>defensive copying</em>.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">Person</span><span class="p">(</span><span class="n">String</span> <span class="n">firstName</span><span class="o">,</span> <span class="n">String</span> <span class="n">lastName</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">children</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">this</span><span class="o">.</span><span class="na">firstName</span> <span class="o">=</span> <span class="n">firstName</span><span class="o">;</span>
  <span class="k">this</span><span class="o">.</span><span class="na">lastName</span> <span class="o">=</span> <span class="n">lastName</span><span class="o">;</span>
  <span class="k">this</span><span class="o">.</span><span class="na">children</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">children</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="n">Date</span> <span class="n">getChildren</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">children</span><span class="o">);</span>
<span class="o">}</span>

<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="na">getChildren</span><span class="o">().</span><span class="na">size</span><span class="o">())</span> <span class="c1">// =&gt; 0.</span>
</code></pre>
</div>

<p>Note that we only need to do a defensive copy if the object is mutable. The Strings firstName and lastName are immutable by default so there is no need to do a defensive copy.</p>


        </section>

        <footer class="post-footer"></footer>
    </article>
</div>

    </div>

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-55713436-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>   
</body>
</html>
